{% extends 'base.html' %}

{% block title %}{{ work.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ work.name }}</h2>
            <div>
                <a href="{% url 'works:generate-variants' work.pk %}" class="btn btn-success">
                    <i class="fas fa-random"></i> –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã
                </a>
                <a href="{% url 'works:list' %}" class="btn btn-secondary">
                    <i class="fas fa-list"></i> –ö —Å–ø–∏—Å–∫—É —Ä–∞–±–æ—Ç
                </a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> {{ work.duration }} –º–∏–Ω—É—Ç
                    </div>
                    <div class="col-md-6">
                        <strong>–°–æ–∑–¥–∞–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:</strong> {{ work.variant_counter }}
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">–°–æ–∑–¥–∞–Ω–æ: {{ work.created_at|date:"d.m.Y H:i" }}</small>
                </div>
            </div>
        </div>

        <h4>–ì—Ä—É–ø–ø—ã –∑–∞–¥–∞–Ω–∏–π –≤ —Ä–∞–±–æ—Ç–µ</h4>
        {% if analog_groups %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>–ì—Ä—É–ø–ø–∞ –∞–Ω–∞–ª–æ–≥–æ–≤</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–Ω–∏–π</th>
                        <th>–î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–¥–∞–Ω–∏–π</th>
                    </tr>
                </thead>
                <tbody>
                    {% for work_group in analog_groups %}
                    <tr>
                        <td>
                            <a href="{% url 'task_groups:detail' work_group.analog_group.pk %}">
                                {{ work_group.analog_group.name }}
                            </a>
                        </td>
                        <td>{{ work_group.count }}</td>
                        <td>{{ work_group.analog_group.taskgroup_set.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning">
            –í —Ä–∞–±–æ—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø –∑–∞–¥–∞–Ω–∏–π. <a href="/admin/">–î–æ–±–∞–≤—å—Ç–µ –≥—Ä—É–ø–ø—ã —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>.
        </div>
        {% endif %}

        <!-- –ë–ª–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="card mb-4 document-generation-block">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-export"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                </h5>
                <small class="text-muted">
                    –í–∞—Ä–∏–∞–Ω—Ç—ã: {{ work.variant_counter }}
                </small>
            </div>
            <div class="card-body">
                <!-- –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-bolt text-warning"></i> –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
                        </h6>
                        <div class="btn-group me-3 mb-2" role="group" aria-label="PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è">
                            <button type="button" class="btn btn-primary btn-generate-doc" 
                                    data-work-id="{{ work.id }}" 
                                    data-type="pdf"
                                    data-with-answers="0"
                                    title="HTML‚ÜíPDF —á–µ—Ä–µ–∑ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫">
                                <i class="fas fa-mobile-alt"></i> PDF
                            </button>
                            <button type="button" class="btn btn-success btn-generate-doc" 
                                    data-work-id="{{ work.id }}" 
                                    data-type="pdf"  
                                    data-with-answers="1"
                                    title="PDF —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –∏ —Ä–µ—à–µ–Ω–∏—è–º–∏">
                                <i class="fas fa-mobile-alt"></i> PDF + –æ—Ç–≤–µ—Ç—ã
                            </button>
                        </div>
                        
                        <div class="btn-group me-3 mb-2" role="group" aria-label="–î—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã">
                            <button type="button" class="btn btn-info btn-generate-doc" 
                                    data-work-id="{{ work.id }}" 
                                    data-type="html"
                                    data-with-answers="0"
                                    title="HTML —Å MathJax —Ñ–æ—Ä–º—É–ª–∞–º–∏">
                                <i class="fas fa-globe"></i> HTML
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-generate-doc" 
                                    data-work-id="{{ work.id }}" 
                                    data-type="latex"
                                    data-with-answers="0"
                                    title="LaTeX –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥">
                                <i class="fas fa-file-code"></i> LaTeX
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="accordion" id="advancedSettings">
                    <div class="accordion-item">
                        <h6 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                <i class="fas fa-cog me-2"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                        </h6>
                        <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#advancedSettings">
                            <div class="accordion-body">
                                <form id="advanced-generation-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="work_id" value="{{ work.id }}">
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="generator_type" class="form-label">–¢–∏–ø –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞:</label>
                                            <select name="generator_type" id="generator_type" class="form-select">
                                                <option value="pdf">üì± PDF (HTML‚ÜíPDF)</option>
                                                <option value="html">üåê HTML (—Å MathJax)</option>
                                                <option value="latex">üìù LaTeX</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-3 mb-3">
                                            <label for="format" class="form-label">–§–æ—Ä–º–∞—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</label>
                                            <select name="format" id="format" class="form-select">
                                                <option value="A4">A4</option>
                                                <option value="A3">A3</option>
                                                <option value="Letter">Letter</option>
                                                <option value="Legal">Legal</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-3 mb-3">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" name="with_answers" id="with_answers" value="1">
                                                <label class="form-check-label" for="with_answers">
                                                    –í–∫–ª—é—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –∏ —Ä–µ—à–µ–Ω–∏—è
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="submit" class="btn btn-primary d-block">
                                                <i class="fas fa-rocket"></i> –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        üìä –†–∞–±–æ—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç: <strong>{{ work.variant_counter }}</strong> {{ work.variant_counter|pluralize:"–≤–∞—Ä–∏–∞–Ω—Ç,–≤–∞—Ä–∏–∞–Ω—Ç–∞,–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤" }}
                        {% if work.workanaloggroup_set.exists %}
                            {% with task_count=work.workanaloggroup_set.all|length %}
                            ‚Ä¢ <strong>{{ task_count }}</strong> {{ task_count|pluralize:"–≥—Ä—É–ø–ø–∞ –∑–∞–¥–∞–Ω–∏–π,–≥—Ä—É–ø–ø—ã –∑–∞–¥–∞–Ω–∏–π,–≥—Ä—É–ø–ø –∑–∞–¥–∞–Ω–∏–π" }}
                            {% endwith %}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>





        <h4 class="mt-4">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ({{ variants.count }})</h4>
        {% if variants %}
        <div class="row">
            {% for variant in variants %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">–í–∞—Ä–∏–∞–Ω—Ç {{ variant.number }}</h6>
                        <p class="card-text">
                            <i class="fas fa-tasks"></i> –ó–∞–¥–∞–Ω–∏–π: {{ variant.tasks.count }}
                        </p>
                        <p class="card-text">
                            <small class="text-muted">–°–æ–∑–¥–∞–Ω: {{ variant.created_at|date:"d.m.Y H:i" }}</small>
                        </p>
                        <a href="{% url 'works:variant-detail' variant.pk %}" class="btn btn-sm btn-outline-primary">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            –í–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{% url 'works:generate-variants' work.pk %}">–°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã</a>.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
